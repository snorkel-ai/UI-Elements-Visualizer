<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversation Viewer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #root { min-height: 100vh; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;

    const conversationData = [
      {
        "role": "user",
        "content": "I\u2019m renovating my kitchen. Track estimates, actual spend, and contractor payments."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Great \u2014 I\u2019ll set you up with a starter dashboard to track your kitchen renovation. You\u2019ll see a budget vs. actual view by line item and a payment schedule you can mark as paid or edit. If you share your total budget and preferred currency, I\u2019ll align everything to your numbers and add a remaining budget indicator. Would you like me to adjust any line items or contractors below?\n\nQuick next steps:\n- Confirm your total budget and currency (e.g., USD).\n- Tell me if you want to add/remove line items (e.g., backsplash, permits).\n- Share any existing payments or due dates to import."
          },
          {
            "type": "component",
            "component": {
              "name": "BudgetVsActualBarChart",
              "props": {
                "items": [
                  {
                    "id": "li_cabinets",
                    "name": "Cabinets",
                    "estimate": 12000,
                    "actual": 12500,
                    "contractorName": "ABC Woodworks",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_appliances",
                    "name": "Appliances",
                    "estimate": 8000,
                    "actual": 7500,
                    "contractorName": "HomeTech Supply",
                    "paymentStatus": "paid"
                  },
                  {
                    "id": "li_countertops",
                    "name": "Countertops",
                    "estimate": 6000,
                    "actual": 5800,
                    "contractorName": "StoneCraft Surfaces",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_flooring",
                    "name": "Flooring",
                    "estimate": 4000,
                    "actual": 4200,
                    "contractorName": "Prime Floors",
                    "paymentStatus": "unpaid"
                  },
                  {
                    "id": "li_electrical",
                    "name": "Electrical",
                    "estimate": 3000,
                    "actual": 2800,
                    "contractorName": "Bright Spark Electric",
                    "paymentStatus": "paid"
                  },
                  {
                    "id": "li_plumbing",
                    "name": "Plumbing",
                    "estimate": 3500,
                    "actual": 3600,
                    "contractorName": "FlowRight Plumbing",
                    "paymentStatus": "partial"
                  }
                ],
                "currencyCode": "USD",
                "variant": "grouped",
                "sortBy": "variance",
                "sortOrder": "desc",
                "showVariance": true,
                "highlightOverBudget": true,
                "overBudgetThresholdPct": 0,
                "maxVisibleItems": 8,
                "tooltipMode": "detailed",
                "locale": "en-US",
                "onItemSelectAction": {
                  "type": "select_line_item"
                }
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "PaymentScheduleTable",
              "props": {
                "payments": [
                  {
                    "id": "pay_001",
                    "contractorId": "ctr_abc_wood",
                    "contractorName": "ABC Woodworks",
                    "dueDate": "2025-11-25",
                    "amount": 6000,
                    "status": "pending",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_001"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_001"
                      }
                    }
                  },
                  {
                    "id": "pay_002",
                    "contractorId": "ctr_hometech",
                    "contractorName": "HomeTech Supply",
                    "dueDate": "2025-11-10",
                    "amount": 7500,
                    "status": "paid",
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_002"
                      }
                    }
                  },
                  {
                    "id": "pay_003",
                    "contractorId": "ctr_stonecraft",
                    "contractorName": "StoneCraft Surfaces",
                    "dueDate": "2025-12-05",
                    "amount": 3000,
                    "status": "pending",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_003"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_003"
                      }
                    }
                  },
                  {
                    "id": "pay_004",
                    "contractorId": "ctr_primefloors",
                    "contractorName": "Prime Floors",
                    "dueDate": "2025-11-15",
                    "amount": 2000,
                    "status": "overdue",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_004"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_004"
                      }
                    }
                  },
                  {
                    "id": "pay_005",
                    "contractorId": "ctr_flowright",
                    "contractorName": "FlowRight Plumbing",
                    "dueDate": "2025-11-28",
                    "amount": 1800,
                    "status": "pending",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_005"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_005"
                      }
                    }
                  }
                ],
                "currency": "USD",
                "defaultSort": {
                  "by": "dueDate",
                  "direction": "asc"
                },
                "highlightOverdue": true,
                "showTotalsRow": true
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should clearly acknowledge the user's goal to track kitchen renovation estimates, actuals, and contractor payments",
            "Should present an overall remaining budget indicator and describe how it is calculated (total budget minus sum of actuals and/or committed payments)",
            "Should request any missing key inputs (e.g., total budget amount, preferred currency) needed to align the tracker",
            "Should provide actionable next steps for the user to add or edit line items, contractors, and payments",
            "Should use a budget vs. actual visualization by line item with variance highlighting and clear labels",
            "Should include a payment schedule table with due dates, amounts, status (pending/paid/overdue), and actions to mark paid or edit",
            "Should provide contractor status visibility (e.g., cards or list) summarizing each contractor's current payment or progress status",
            "Should ensure data consistency between line items, contractors, and payments (e.g., contractor names and IDs match across components)",
            "Should align currency and number formatting to the user's specified locale and currency",
            "Should enable sorting and filtering that supports budget oversight (e.g., variance high to low, due date ascending, overdue highlighting)",
            "Should avoid calling tools unless external data fetching or computation is required; otherwise use provided data and components directly",
            "Should avoid hallucinating unavailable data; any sample data should be clearly presented as placeholders that can be edited",
            "Should wire interactive actions appropriately (e.g., mark as paid, edit payment, select line item) with correct payload identifiers",
            "Should be concise, user-oriented, and avoid unnecessary technical jargon while giving clear guidance on how to proceed",
            "Should ensure dates are valid ISO or locale-appropriate formats and payment statuses are clearly indicated",
            "Should highlight over-budget line items and overdue payments in the UI for quick attention"
          ],
          "expected_components": [
            "BudgetVsActualBarChart",
            "PaymentScheduleTable",
            "ContractorStatusCards",
            "RemainingBudgetIndicator"
          ]
        }
      },
      {
        "role": "user",
        "content": "Total budget is $45,000 USD. Please set line items to: cabinets 12k, countertops 6k, appliances 8k (spent 2k so far), flooring 4k, electrical 3k, plumbing 3.5k, backsplash 2k, permits 1k, contingency 5.5k; add contractors: BuildRight GC (active), SparkCo Electric (scheduled), FlowPro Plumbing (not started), and log payments: $5,000 deposit to GC paid 11/10/2025, $8,000 to GC due 12/01/2025, $1,500 to SparkCo due 11/28/2025."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "All set. I\u2019ve initialized your kitchen renovation tracker with your $45,000 USD budget, line items, and payment schedule. Quick snapshot: you\u2019ve spent about $7,000 so far ($2,000 on Appliances + $5,000 paid to BuildRight GC), leaving roughly $38,000 remaining. Upcoming payments: $1,500 to SparkCo due 2025-11-28 and $8,000 to BuildRight GC due 2025-12-01. Would you like me to link specific line items to each contractor (e.g., cabinets/countertops to BuildRight, electrical to SparkCo, plumbing to FlowPro) and display contractor cards plus a remaining budget indicator next? You can also click a line item to focus it or mark payments as paid below."
          },
          {
            "type": "component",
            "component": {
              "name": "BudgetVsActualBarChart",
              "props": {
                "items": [
                  {
                    "id": "li_cabinets",
                    "name": "Cabinets",
                    "estimate": 12000,
                    "actual": 0,
                    "contractorName": "BuildRight GC"
                  },
                  {
                    "id": "li_countertops",
                    "name": "Countertops",
                    "estimate": 6000,
                    "actual": 0,
                    "contractorName": "BuildRight GC"
                  },
                  {
                    "id": "li_appliances",
                    "name": "Appliances",
                    "estimate": 8000,
                    "actual": 2000
                  },
                  {
                    "id": "li_flooring",
                    "name": "Flooring",
                    "estimate": 4000,
                    "actual": 0,
                    "contractorName": "BuildRight GC"
                  },
                  {
                    "id": "li_electrical",
                    "name": "Electrical",
                    "estimate": 3000,
                    "actual": 0,
                    "contractorName": "SparkCo Electric"
                  },
                  {
                    "id": "li_plumbing",
                    "name": "Plumbing",
                    "estimate": 3500,
                    "actual": 0,
                    "contractorName": "FlowPro Plumbing"
                  },
                  {
                    "id": "li_backsplash",
                    "name": "Backsplash",
                    "estimate": 2000,
                    "actual": 0,
                    "contractorName": "BuildRight GC"
                  },
                  {
                    "id": "li_permits",
                    "name": "Permits",
                    "estimate": 1000,
                    "actual": 0
                  },
                  {
                    "id": "li_contingency",
                    "name": "Contingency",
                    "estimate": 5500,
                    "actual": 0
                  }
                ],
                "currencyCode": "USD",
                "variant": "grouped",
                "sortBy": "name",
                "sortOrder": "asc",
                "showVariance": true,
                "highlightOverBudget": true,
                "overBudgetThresholdPct": 0,
                "tooltipMode": "detailed",
                "onItemSelectAction": {
                  "type": "select_line_item"
                }
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "PaymentScheduleTable",
              "props": {
                "payments": [
                  {
                    "id": "pay_gc_1",
                    "contractorId": "ctr_buildright",
                    "contractorName": "BuildRight GC",
                    "dueDate": "2025-11-10",
                    "amount": 5000,
                    "status": "paid",
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_gc_1"
                      }
                    }
                  },
                  {
                    "id": "pay_spark_1",
                    "contractorId": "ctr_sparkco",
                    "contractorName": "SparkCo Electric",
                    "dueDate": "2025-11-28",
                    "amount": 1500,
                    "status": "pending",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_spark_1"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_spark_1"
                      }
                    }
                  },
                  {
                    "id": "pay_gc_2",
                    "contractorId": "ctr_buildright",
                    "contractorName": "BuildRight GC",
                    "dueDate": "2025-12-01",
                    "amount": 8000,
                    "status": "pending",
                    "markPaidAction": {
                      "type": "mark_paid",
                      "payload": {
                        "id": "pay_gc_2"
                      }
                    },
                    "editPaymentAction": {
                      "type": "edit_payment",
                      "payload": {
                        "id": "pay_gc_2"
                      }
                    }
                  }
                ],
                "currency": "USD",
                "defaultSort": {
                  "by": "dueDate",
                  "direction": "asc"
                },
                "highlightOverdue": true,
                "showTotalsRow": true
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should capture the total budget as $45,000 USD and ensure line-item estimates match the user's specified amounts (summing to the total budget)",
            "Should record actual spend of $2,000 on Appliances and compute a correct overall actual spend and remaining budget, presented in USD",
            "Should associate contractors to relevant line items as implied: BuildRight GC for cabinets/countertops/flooring/backsplash, SparkCo Electric for electrical, FlowPro Plumbing for plumbing",
            "Should include clear contractor status indicators: BuildRight GC (active), SparkCo Electric (scheduled), FlowPro Plumbing (not started)",
            "Should present a Budget vs Actual visualization for each line item, including estimates vs actuals, variance, and over-budget highlighting where applicable",
            "Should provide an interactive payment schedule listing all three payments with accurate amounts, contractors, due dates, and statuses (paid/pending), and include mark-paid and edit actions",
            "Should compute and display an overall remaining budget indicator derived from total budget minus actual spend (and optionally show committed amounts separately if displayed)",
            "Should use consistent currency formatting (USD) and ISO-format dates (YYYY-MM-DD) for due dates",
            "Should offer intuitive interactions such as selecting a line item to focus, marking payments as paid, and editing payment entries",
            "Should avoid unnecessary tool calls; perform straightforward calculations locally and only call tools if external data is required",
            "Should present information concisely and clearly, matching the user's requested visual layout and providing actionable next steps if relevant",
            "Should ensure component properties (sorting, highlighting, variance display, tooltips) are configured to support the user's tracking needs"
          ],
          "expected_components": [
            "BudgetVsActualBarChart",
            "PaymentScheduleTable",
            "ContractorCards",
            "RemainingBudgetIndicator"
          ]
        }
      },
      {
        "role": "user",
        "content": "Yes\u2014link line items as follows: BuildRight GC = cabinets, countertops, flooring, backsplash, permits; SparkCo = electrical; FlowPro = plumbing; appliances and contingency unassigned. Please show contractor cards and the remaining budget indicator. Also allocate the $5,000 GC deposit proportionally across BuildRight\u2019s items."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Got it. I linked your line items to contractors as requested and allocated the $5,000 BuildRight GC deposit proportionally across their items. Allocation across BuildRight\u2019s scope ($25,000 total) is: Cabinets $2,400, Countertops $1,200, Flooring $800, Backsplash $400, Permits $200. Appliances retains the $2,000 actual you reported; other items are at $0 actual for now.\n\nSnapshot:\n- Total budget: $45,000 USD\n- Actual to date: $7,000 (Appliances $2,000 + BuildRight deposit $5,000)\n- Remaining: $38,000\n- Upcoming payments: SparkCo $1,500 due 2025-11-28; BuildRight $8,000 due 2025-12-01\n\nContractor statuses:\n- BuildRight GC: active (deposit paid; next payment due 2025-12-01)\n- SparkCo Electric: scheduled/pending (next payment due 2025-11-28)\n- FlowPro Plumbing: not started/pending\n\nIf you\u2019d like, I can surface individual contractor cards in the view next to the chart or switch the chart to group by contractor. You can also click any line item bar to focus details or adjust allocations."
          },
          {
            "type": "component",
            "component": {
              "name": "RemainingBudgetIndicator",
              "props": {
                "totalBudget": 45000,
                "totalActual": 7000,
                "remaining": 38000,
                "currency": "USD",
                "trend": "flat"
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "BudgetVsActualBarChart",
              "props": {
                "items": [
                  {
                    "id": "li_cabinets",
                    "name": "Cabinets",
                    "estimate": 12000,
                    "actual": 2400,
                    "contractorName": "BuildRight GC",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_countertops",
                    "name": "Countertops",
                    "estimate": 6000,
                    "actual": 1200,
                    "contractorName": "BuildRight GC",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_appliances",
                    "name": "Appliances",
                    "estimate": 8000,
                    "actual": 2000,
                    "paymentStatus": "unpaid"
                  },
                  {
                    "id": "li_flooring",
                    "name": "Flooring",
                    "estimate": 4000,
                    "actual": 800,
                    "contractorName": "BuildRight GC",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_electrical",
                    "name": "Electrical",
                    "estimate": 3000,
                    "actual": 0,
                    "contractorName": "SparkCo Electric",
                    "paymentStatus": "unpaid"
                  },
                  {
                    "id": "li_plumbing",
                    "name": "Plumbing",
                    "estimate": 3500,
                    "actual": 0,
                    "contractorName": "FlowPro Plumbing",
                    "paymentStatus": "unpaid"
                  },
                  {
                    "id": "li_backsplash",
                    "name": "Backsplash",
                    "estimate": 2000,
                    "actual": 400,
                    "contractorName": "BuildRight GC",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_permits",
                    "name": "Permits",
                    "estimate": 1000,
                    "actual": 200,
                    "contractorName": "BuildRight GC",
                    "paymentStatus": "partial"
                  },
                  {
                    "id": "li_contingency",
                    "name": "Contingency",
                    "estimate": 5500,
                    "actual": 0,
                    "paymentStatus": "unpaid"
                  }
                ],
                "currencyCode": "USD",
                "variant": "grouped",
                "sortBy": "variance",
                "sortOrder": "desc",
                "showVariance": true,
                "highlightOverBudget": true,
                "overBudgetThresholdPct": 0,
                "tooltipMode": "detailed",
                "onItemSelectAction": {
                  "type": "select_line_item"
                }
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should explicitly link line items to contractors exactly as the user mapped: BuildRight GC = cabinets, countertops, flooring, backsplash, permits; SparkCo = electrical; FlowPro = plumbing; appliances and contingency unassigned",
            "Should allocate the $5,000 BuildRight GC deposit proportionally across BuildRight\u2019s items based on their relative estimates within BuildRight\u2019s scope, with allocation amounts summing to $5,000 and reflected in each item\u2019s actuals and payment status",
            "Should update and present overall financials accurately, including total budget, actual to date (including the deposit and any previously reported actuals), remaining budget, and currency consistency",
            "Should display a remaining budget indicator component populated with correct totals, remaining amount, currency, and a reasonable trend indicator",
            "Should present contractor cards for BuildRight GC, SparkCo Electric, and FlowPro Plumbing with clear statuses (e.g., active, scheduled/pending, not started), and relevant upcoming payment information where applicable",
            "Should include a budget vs actual bar chart by line item that reflects the updated contractor assignments, estimates, actuals (including proportional allocations), and payment statuses; unassigned items should not list a contractor",
            "Should provide or summarize a payment schedule (e.g., upcoming payments such as SparkCo $1,500 due 2025-11-28 and BuildRight $8,000 due 2025-12-01) in a structured form (table component if available) consistent with the data shown elsewhere",
            "Should maintain internal data consistency across narrative text and component props (totals, item actuals, contractor names, due dates, and statuses must match)",
            "Should avoid unsupported assumptions; if any assumptions are necessary (e.g., allocation method), they should align with the request and scenario context and be transparently stated",
            "Should use UI components appropriate to the scenario and user\u2019s request, with correct and complete props for each component; components should be suitable for the intended visualizations and summaries",
            "Should not invoke external tools since all data is provided; if tools are necessary for computation or data fetching, they should be called with correct arguments and results integrated coherently"
          ],
          "expected_components": [
            "RemainingBudgetIndicator",
            "BudgetVsActualBarChart",
            "ContractorCards",
            "PaymentScheduleTable"
          ]
        }
      },
      {
        "role": "user",
        "content": "Yes\u2014please surface the contractor cards next to the chart and switch the chart to group by contractor. Mark SparkCo\u2019s $1,500 payment as paid today. Also log an additional $3,200 actual to Cabinets dated 11/19/2025."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Updates applied: marked SparkCo\u2019s $1,500 as paid today and logged $3,200 additional actual to Cabinets dated 2025-11-19. Your chart is now grouped by contractor, and contractor cards are shown next to it.\n\nSnapshot\n- Total budget: $45,000 USD\n- Actual to date: $11,700\n- Remaining: $33,300\n- Next payments: BuildRight GC $8,000 due 2025-12-01 (scheduled)\n\nLine item actuals (key ones): Cabinets $5,600; Countertops $1,200; Flooring $800; Backsplash $400; Permits $200; Appliances $2,000; Electrical $1,500; Plumbing $0; Contingency $0.\n\nContractors\n- BuildRight GC: active, allocated $25,000, spent $8,200, next due 2025-12-01\n- SparkCo Electric: active, allocated $3,000, spent $1,500\n- FlowPro Plumbing: on_hold, allocated $3,500, spent $0\n\nYou can click any bar to focus a line item, or mark/update payments from the schedule. Want me to set an overdue warning window (e.g., highlight items due within 7 days)?"
          },
          {
            "type": "component",
            "component": {
              "name": "RenovationBudgetDashboard",
              "props": {
                "totalBudget": 45000,
                "totalActual": 11700,
                "currency": "USD",
                "lineItems": [
                  {
                    "id": "li_cabinets",
                    "name": "Cabinets",
                    "estimate": 12000,
                    "actual": 5600,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_countertops",
                    "name": "Countertops",
                    "estimate": 6000,
                    "actual": 1200,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_appliances",
                    "name": "Appliances",
                    "estimate": 8000,
                    "actual": 2000
                  },
                  {
                    "id": "li_flooring",
                    "name": "Flooring",
                    "estimate": 4000,
                    "actual": 800,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_electrical",
                    "name": "Electrical",
                    "estimate": 3000,
                    "actual": 1500,
                    "contractorId": "c_sparkco"
                  },
                  {
                    "id": "li_plumbing",
                    "name": "Plumbing",
                    "estimate": 3500,
                    "actual": 0,
                    "contractorId": "c_flowpro"
                  },
                  {
                    "id": "li_backsplash",
                    "name": "Backsplash",
                    "estimate": 2000,
                    "actual": 400,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_permits",
                    "name": "Permits",
                    "estimate": 1000,
                    "actual": 200,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_contingency",
                    "name": "Contingency",
                    "estimate": 5500,
                    "actual": 0
                  }
                ],
                "payments": [
                  {
                    "id": "p_gc_deposit",
                    "contractorId": "c_buildright",
                    "dueDate": "2025-11-10",
                    "amount": 5000,
                    "status": "paid",
                    "memo": "Deposit"
                  },
                  {
                    "id": "p_gc_8000",
                    "contractorId": "c_buildright",
                    "dueDate": "2025-12-01",
                    "amount": 8000,
                    "status": "scheduled",
                    "memo": "Milestone payment"
                  },
                  {
                    "id": "p_sparkco_1500",
                    "contractorId": "c_sparkco",
                    "dueDate": "2025-11-28",
                    "amount": 1500,
                    "status": "paid",
                    "memo": "Initial service fee"
                  }
                ],
                "contractors": [
                  {
                    "id": "c_buildright",
                    "name": "BuildRight GC",
                    "status": "active",
                    "allocatedBudget": 25000,
                    "spentToDate": 8200,
                    "nextPaymentDue": "2025-12-01"
                  },
                  {
                    "id": "c_sparkco",
                    "name": "SparkCo Electric",
                    "status": "active",
                    "allocatedBudget": 3000,
                    "spentToDate": 1500
                  },
                  {
                    "id": "c_flowpro",
                    "name": "FlowPro Plumbing",
                    "status": "on_hold",
                    "allocatedBudget": 3500,
                    "spentToDate": 0
                  }
                ],
                "chartMode": "by_contractor",
                "dateFormat": "iso",
                "overdueThresholdDays": 7,
                "selectLineItemAction": {
                  "type": "select_line_item"
                },
                "paymentAction": {
                  "type": "update_payment"
                },
                "updateContractorStatusAction": {
                  "type": "update_contractor_status"
                }
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "RemainingBudgetIndicator",
              "props": {
                "totalBudget": 45000,
                "totalActual": 11700,
                "remaining": 33300,
                "currency": "USD",
                "trend": "flat"
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should explicitly confirm all requested updates: chart grouped by contractor, contractor cards surfaced next to the chart, SparkCo\u2019s $1,500 marked paid with today\u2019s date, and an additional $3,200 actual logged to Cabinets dated 2025-11-19",
            "Should update data consistently across text and component props, with no discrepancies between summaries and underlying properties",
            "Should recalculate and display updated rollups: total actual to date, remaining budget, and any affected contractor spent-to-date values (e.g., BuildRight GC if Cabinets belongs to them, SparkCo based on payment status change)",
            "Should update the specific line item actuals (Cabinets) by adding $3,200 and reflect the correct date for the new actual entry",
            "Should update the payment schedule to reflect SparkCo\u2019s $1,500 as paid with an appropriate paid date or status metadata consistent with the system\u2019s schema",
            "Should present the chart in 'by contractor' mode and ensure contractor cards are visibly associated with or positioned next to the chart according to the UI paradigm",
            "Should maintain correct currency formatting (USD) and ISO date formatting when dateFormat is set to iso",
            "Should ensure the Remaining Budget Indicator reflects the recalculated totals after the updates",
            "Should use the specified UI components and props to render updated data, including any interactive actions for selecting line items and updating payments",
            "Should avoid unnecessary tool calls; if external data fetch or computation were required, should call appropriate tools with correct arguments"
          ],
          "expected_components": [
            "RenovationBudgetDashboard",
            "RemainingBudgetIndicator"
          ]
        }
      },
      {
        "role": "user",
        "content": "Yes\u2014set the overdue warning to 7 days. Update SparkCo status to active, and schedule FlowPro to start on 12/05/2025 with a $1,000 deposit due that day. Add a note to SparkCo\u2019s $1,500 payment: \u201cInvoice #S-114 paid via card,\u201d and export a PDF summary of the dashboard."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "All set. I updated the overdue warning window to 7 days, set SparkCo to active, scheduled FlowPro to start on 2025-12-05 with a $1,000 deposit due that day, and added the note to SparkCo\u2019s payment: \u201cInvoice #S-114 paid via card.\u201d I\u2019ve also switched the chart to group by contractor and surfaced the contractor cards. PDF export is being generated now\u2014you\u2019ll receive the download prompt shortly.\n\nQuick snapshot\n- Total budget: $45,000 USD\n- Actual to date: $11,700\n- Remaining: $33,300\n- Next payments: BuildRight GC $8,000 due 2025-12-01 (scheduled); FlowPro $1,000 due 2025-12-05 (scheduled)\n\nIf you want, I can also add a payment schedule table to review upcoming vs. paid items at a glance."
          },
          {
            "type": "component",
            "component": {
              "name": "RenovationBudgetDashboard",
              "props": {
                "totalBudget": 45000,
                "currency": "USD",
                "lineItems": [
                  {
                    "id": "li_cabinets",
                    "name": "Cabinets",
                    "estimate": 12000,
                    "actual": 5600,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_countertops",
                    "name": "Countertops",
                    "estimate": 6000,
                    "actual": 1200,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_flooring",
                    "name": "Flooring",
                    "estimate": 4000,
                    "actual": 800,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_backsplash",
                    "name": "Backsplash",
                    "estimate": 2000,
                    "actual": 400,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_permits",
                    "name": "Permits",
                    "estimate": 1000,
                    "actual": 200,
                    "contractorId": "c_buildright"
                  },
                  {
                    "id": "li_electrical",
                    "name": "Electrical",
                    "estimate": 3000,
                    "actual": 1500,
                    "contractorId": "c_spark"
                  },
                  {
                    "id": "li_plumbing",
                    "name": "Plumbing",
                    "estimate": 3500,
                    "actual": 0,
                    "contractorId": "c_flow"
                  },
                  {
                    "id": "li_appliances",
                    "name": "Appliances",
                    "estimate": 10000,
                    "actual": 2000
                  },
                  {
                    "id": "li_contingency",
                    "name": "Contingency",
                    "estimate": 3500,
                    "actual": 0
                  }
                ],
                "payments": [
                  {
                    "id": "p_spark_1500",
                    "contractorId": "c_spark",
                    "dueDate": "2025-11-28",
                    "amount": 1500,
                    "status": "paid",
                    "memo": "Invoice #S-114 paid via card"
                  },
                  {
                    "id": "p_buildright_8000",
                    "contractorId": "c_buildright",
                    "dueDate": "2025-12-01",
                    "amount": 8000,
                    "status": "scheduled"
                  },
                  {
                    "id": "p_flowpro_1000",
                    "contractorId": "c_flow",
                    "dueDate": "2025-12-05",
                    "amount": 1000,
                    "status": "scheduled",
                    "memo": "Start deposit"
                  }
                ],
                "contractors": [
                  {
                    "id": "c_buildright",
                    "name": "BuildRight GC",
                    "status": "active",
                    "allocatedBudget": 25000,
                    "spentToDate": 8200,
                    "nextPaymentDue": "2025-12-01"
                  },
                  {
                    "id": "c_spark",
                    "name": "SparkCo Electric",
                    "status": "active",
                    "allocatedBudget": 3000,
                    "spentToDate": 1500
                  },
                  {
                    "id": "c_flow",
                    "name": "FlowPro Plumbing",
                    "status": "active",
                    "allocatedBudget": 3500,
                    "spentToDate": 0,
                    "nextPaymentDue": "2025-12-05"
                  }
                ],
                "chartMode": "by_contractor",
                "dateFormat": "iso",
                "overdueThresholdDays": 7,
                "selectLineItemAction": {
                  "type": "select_line_item"
                },
                "paymentAction": {
                  "type": "update_payment"
                },
                "updateContractorStatusAction": {
                  "type": "update_contractor_status"
                }
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "RemainingBudgetIndicator",
              "props": {
                "totalBudget": 45000,
                "totalActual": 11700,
                "remaining": 33300,
                "currency": "USD",
                "trend": "flat"
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should explicitly confirm setting the overdue warning threshold to 7 days",
            "Should update SparkCo (SparkCo Electric) contractor status to active",
            "Should schedule FlowPro (FlowPro Plumbing) to start on 2025-12-05 with a $1,000 deposit due on that date",
            "Should add the memo \u201cInvoice #S-114 paid via card\u201d to SparkCo\u2019s $1,500 payment",
            "Should generate and provide a PDF summary export of the dashboard, or initiate the export via the appropriate tool and indicate delivery method",
            "Should present a concise snapshot of total budget, actual to date, remaining, and upcoming payments consistent with the underlying data",
            "Should ensure all totals, remaining amounts, and payment statuses are internally consistent across text and components",
            "Should display a budget vs. actual bar chart grouped by line item, unless the user requests a different grouping",
            "Should include a payment schedule table showing upcoming and paid items",
            "Should show contractor cards with statuses and next payment information",
            "Should use the RenovationBudgetDashboard to reflect all requested updates (overdue threshold, payments, contractor statuses, scheduling) with correct props and data structures",
            "Should use the RemainingBudgetIndicator to show total budget, total actual, remaining, currency, and trend",
            "Should use clear date formats (e.g., ISO) and consistent currency formatting",
            "Should avoid claiming actions that require external capabilities unless a tool/action is invoked; if not possible, should state limitations and propose alternatives",
            "Should maintain a concise, task-focused tone, offering optional next steps without introducing irrelevant details"
          ],
          "expected_components": [
            "RenovationBudgetDashboard",
            "RemainingBudgetIndicator"
          ]
        }
      }
    ];

    // Utils
    const formatCurrency = (value, currency = 'USD', locale = 'en-US') => {
      try {
        return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(value || 0);
      } catch (e) {
        return `$${(value || 0).toFixed(2)}`;
      }
    };

    const parseISODate = (d) => {
      if (!d) return null;
      const dt = new Date(d);
      return isNaN(dt.getTime()) ? null : dt;
    };

    const daysUntil = (dateStr) => {
      const dt = parseISODate(dateStr);
      if (!dt) return null;
      const now = new Date();
      const diff = dt.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    };

    // Components

    const RemainingBudgetIndicator = (props) => {
      const {
        totalBudget = 0,
        totalActual = 0,
        remaining = Math.max(0, (totalBudget || 0) - (totalActual || 0)),
        currency = 'USD',
        trend = 'flat'
      } = props;

      const spentPct = totalBudget > 0 ? Math.min(100, Math.max(0, (totalActual / totalBudget) * 100)) : 0;
      const remainingPct = 100 - spentPct;

      const trendInfo = {
        up: { label: 'Up', color: 'text-green-600', symbol: '▲' },
        down: { label: 'Down', color: 'text-red-600', symbol: '▼' },
        flat: { label: 'Flat', color: 'text-gray-500', symbol: '■' }
      }[trend] || { label: 'Flat', color: 'text-gray-500', symbol: '■' };

      return (
        <div className="w-full bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-gray-700">Remaining Budget</h3>
            <span className={`text-xs ${trendInfo.color}`}>{trendInfo.symbol} {trendInfo.label}</span>
          </div>
          <div className="mb-2">
            <div className="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
              <div className="h-3 bg-blue-600" style={{ width: `${spentPct}%` }}></div>
            </div>
          </div>
          <div className="grid grid-cols-3 gap-2 text-sm">
            <div className="bg-gray-50 rounded p-2">
              <div className="text-gray-500">Total</div>
              <div className="font-medium">{formatCurrency(totalBudget, currency)}</div>
            </div>
            <div className="bg-gray-50 rounded p-2">
              <div className="text-gray-500">Actual</div>
              <div className="font-medium">{formatCurrency(totalActual, currency)}</div>
            </div>
            <div className="bg-gray-50 rounded p-2">
              <div className="text-gray-500">Remaining</div>
              <div className="font-medium">{formatCurrency(remaining, currency)}</div>
            </div>
          </div>
          <div className="mt-2 text-xs text-gray-500">Spent {spentPct.toFixed(1)}% • Remaining {remainingPct.toFixed(1)}%</div>
        </div>
      );
    };

    const BudgetVsActualBarChart = (props) => {
      const {
        items = [],
        currencyCode = 'USD',
        variant = 'grouped',
        sortBy = 'name',
        sortOrder = 'asc',
        showVariance = true,
        highlightOverBudget = true,
        overBudgetThresholdPct = 0,
        maxVisibleItems = 999,
        tooltipMode = 'auto',
        locale = 'en-US',
        onItemSelectAction = null
      } = props;

      const processed = useMemo(() => {
        const arr = Array.isArray(items) ? items.map((it) => {
          const estimate = Number(it.estimate || 0);
          const actual = Number(it.actual || 0);
          const variance = estimate - actual;
          const overUnder = actual - estimate;
          return { ...it, estimate, actual, variance, overUnder };
        }) : [];

        const sorter = (a, b) => {
          const dir = sortOrder === 'desc' ? -1 : 1;
          switch (sortBy) {
            case 'estimate': return (a.estimate - b.estimate) * dir;
            case 'actual': return (a.actual - b.actual) * dir;
            case 'variance': return (a.variance - b.variance) * dir;
            case 'overUnder': return (a.overUnder - b.overUnder) * dir;
            case 'name':
            default: return (a.name || '').localeCompare(b.name || '') * dir;
          }
        };
        arr.sort(sorter);
        return arr.slice(0, maxVisibleItems);
      }, [items, sortBy, sortOrder, maxVisibleItems]);

      const maxValue = useMemo(() => {
        if (!processed.length) return 0;
        if (variant === 'stacked') {
          return Math.max(...processed.map(it => (it.estimate + it.actual)));
        } else {
          return Math.max(...processed.map(it => Math.max(it.estimate, it.actual)));
        }
      }, [processed, variant]);

      const handleSelect = (item) => {
        if (onItemSelectAction) {
          console.log('onItemSelectAction', onItemSelectAction, 'item', item);
          alert(`Selected: ${item.name}`);
        }
      };

      return (
        <div className="w-full bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-semibold text-gray-700">Budget vs Actual</h3>
            <div className="text-xs text-gray-500 flex items-center gap-2">
              <span className="inline-flex items-center"><span className="w-3 h-3 inline-block bg-gray-300 mr-1 rounded-sm"></span>Estimate</span>
              <span className="inline-flex items-center"><span className="w-3 h-3 inline-block bg-blue-600 mr-1 rounded-sm"></span>Actual</span>
            </div>
          </div>
          {!processed.length ? (
            <div className="text-sm text-gray-500">No items to display.</div>
          ) : (
            <div className="space-y-3">
              {processed.map((it) => {
                const base = maxValue > 0 ? (100 / maxValue) : 0;
                const estW = Math.max(0.5, it.estimate * base);
                const actW = Math.max(0.5, it.actual * base);
                const overBudget = highlightOverBudget && it.actual > it.estimate * (1 + overBudgetThresholdPct);
                return (
                  <div key={it.id || it.name} className="group">
                    <div className="flex items-center justify-between mb-1">
                      <div className="text-sm font-medium text-gray-700">{it.name}</div>
                      <div className="text-xs text-gray-500">
                        {formatCurrency(it.estimate, currencyCode, locale)} est · {formatCurrency(it.actual, currencyCode, locale)} actual
                      </div>
                    </div>
                    {variant === 'stacked' ? (
                      <div className="w-full h-6 bg-gray-100 rounded overflow-hidden">
                        <div className="h-6 bg-gray-300 inline-block" style={{ width: `${estW}%` }} title="Estimate"></div>
                        <div className={`h-6 inline-block ${overBudget ? 'bg-red-500' : 'bg-blue-600'}`} style={{ width: `${actW}%` }} title="Actual"></div>
                      </div>
                    ) : (
                      <div className="grid grid-cols-12 gap-2 items-center">
                        <div className="col-span-6">
                          <div className="w-full h-4 bg-gray-100 rounded">
                            <div className="h-4 bg-gray-300 rounded" style={{ width: `${estW}%` }}></div>
                          </div>
                        </div>
                        <div className="col-span-6">
                          <div className="w-full h-4 bg-gray-100 rounded cursor-pointer" onClick={() => handleSelect(it)}>
                            <div className={`h-4 ${overBudget ? 'bg-red-500' : 'bg-blue-600'} rounded`} style={{ width: `${actW}%` }}></div>
                          </div>
                        </div>
                      </div>
                    )}
                    <div className="mt-1 flex items-center justify-between text-xs">
                      <div className="text-gray-500">
                        {it.contractorName ? <span className="mr-2">👷 {it.contractorName}</span> : null}
                        {it.paymentStatus ? <span className="px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">{it.paymentStatus}</span> : null}
                      </div>
                      {showVariance ? (
                        <div className={`font-medium ${it.variance < 0 ? 'text-red-600' : 'text-gray-700'}`}>
                          Var: {formatCurrency(it.variance, currencyCode, locale)}
                        </div>
                      ) : null}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          {tooltipMode !== 'auto' ? (
            <div className="mt-3 text-[11px] text-gray-400">Tooltip: {tooltipMode}</div>
          ) : null}
        </div>
      );
    };

    const PaymentScheduleTable = (props) => {
      const {
        payments = [],
        currency = 'USD',
        defaultSort = { by: 'dueDate', direction: 'asc' },
        highlightOverdue = true,
        showTotalsRow = false,
        overdueThresholdDays = 7 // optional, not in schema but supported
      } = props;

      const [rows, setRows] = useState(Array.isArray(payments) ? payments.map(p => ({ ...p })) : []);
      const [sort, setSort] = useState(defaultSort);

      useEffect(() => {
        setRows(Array.isArray(payments) ? payments.map(p => ({ ...p })) : []);
      }, [payments]);

      const sortedRows = useMemo(() => {
        const r = [...rows];
        const dir = sort.direction === 'desc' ? -1 : 1;
        const by = sort.by;
        r.sort((a, b) => {
          if (by === 'amount') return (Number(a.amount) - Number(b.amount)) * dir;
          if (by === 'status') return ((a.status || '').localeCompare(b.status || '')) * dir;
          if (by === 'contractorName') return ((a.contractorName || '').localeCompare(b.contractorName || '')) * dir;
          // dueDate default
          const ad = parseISODate(a.dueDate)?.getTime() || 0;
          const bd = parseISODate(b.dueDate)?.getTime() || 0;
          return (ad - bd) * dir;
        });
        return r;
      }, [rows, sort]);

      const totalAmount = useMemo(() => sortedRows.reduce((sum, p) => sum + (Number(p.amount) || 0), 0), [sortedRows]);

      const toggleSort = (by) => {
        setSort((s) => {
          if (s.by === by) {
            return { ...s, direction: s.direction === 'asc' ? 'desc' : 'asc' };
          }
          return { by, direction: 'asc' };
        });
      };

      const markPaid = (id) => {
        setRows((prev) => prev.map(p => {
          if (p.id === id) {
            return { ...p, status: 'paid', paidDate: new Date().toISOString().slice(0,10) };
          }
          return p;
        }));
      };

      const isOverdue = (p) => {
        if (p.status === 'paid') return false;
        const due = parseISODate(p.dueDate);
        if (!due) return false;
        const now = new Date();
        return due < new Date(now.getFullYear(), now.getMonth(), now.getDate());
      };

      const isDueSoon = (p) => {
        if (p.status === 'paid') return false;
        const days = daysUntil(p.dueDate);
        if (days === null) return false;
        return days >= 0 && days <= overdueThresholdDays;
      };

      return (
        <div className="w-full bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h3 className="text-sm font-semibold text-gray-700">Payment Schedule</h3>
            <div className="text-xs text-gray-500">Overdue window: {overdueThresholdDays} days</div>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-2 text-left cursor-pointer" onClick={() => toggleSort('contractorName')}>Contractor</th>
                  <th className="px-4 py-2 text-left cursor-pointer" onClick={() => toggleSort('dueDate')}>Due Date</th>
                  <th className="px-4 py-2 text-right cursor-pointer" onClick={() => toggleSort('amount')}>Amount</th>
                  <th className="px-4 py-2 text-left cursor-pointer" onClick={() => toggleSort('status')}>Status</th>
                  <th className="px-4 py-2 text-left">Memo</th>
                  <th className="px-4 py-2 text-right">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {sortedRows.length === 0 ? (
                  <tr>
                    <td colSpan="6" className="px-4 py-6 text-center text-gray-500">No payments scheduled.</td>
                  </tr>
                ) : sortedRows.map((p) => {
                  const overdue = highlightOverdue && isOverdue(p);
                  const soon = highlightOverdue && isDueSoon(p);
                  return (
                    <tr key={p.id} className={`${overdue ? 'bg-red-50' : soon ? 'bg-yellow-50' : ''}`}>
                      <td className="px-4 py-2 text-gray-700">{p.contractorName || p.contractorId}</td>
                      <td className="px-4 py-2 text-gray-600">{p.dueDate || '-'}</td>
                      <td className="px-4 py-2 text-right font-medium">{formatCurrency(p.amount, currency)}</td>
                      <td className="px-4 py-2">
                        <span className={`px-2 py-0.5 rounded-full text-xs ${p.status === 'paid' ? 'bg-green-100 text-green-700' : overdue ? 'bg-red-100 text-red-700' : soon ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}`}>
                          {p.status || 'pending'}
                        </span>
                        {p.paidDate ? <span className="ml-2 text-xs text-gray-500">(paid {p.paidDate})</span> : null}
                      </td>
                      <td className="px-4 py-2 text-gray-500">{p.memo || ''}</td>
                      <td className="px-4 py-2 text-right">
                        {p.status !== 'paid' && p.markPaidAction ? (
                          <button onClick={() => markPaid(p.id)} className="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700">Mark paid</button>
                        ) : (
                          <span className="text-xs text-gray-400">—</span>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
              {showTotalsRow && sortedRows.length > 0 ? (
                <tfoot className="bg-gray-50">
                  <tr>
                    <td className="px-4 py-2 font-medium text-gray-700" colSpan="2">Total</td>
                    <td className="px-4 py-2 text-right font-semibold">{formatCurrency(totalAmount, currency)}</td>
                    <td className="px-4 py-2" colSpan="3"></td>
                  </tr>
                </tfoot>
              ) : null}
            </table>
          </div>
        </div>
      );
    };

    const ContractorCard = (props) => {
      const {
        id,
        name,
        status = {},
        allocatedBudget = 0,
        spentToDate = 0,
        nextPaymentDue,
        imageUrl,
        action
      } = props;

      const statusText = typeof status === 'string' ? status : (status?.label || 'unknown');
      const pct = allocatedBudget > 0 ? Math.min(100, Math.max(0, (spentToDate / allocatedBudget) * 100)) : 0;

      const onAction = () => {
        if (action) {
          console.log('Contractor action', action, { id, name });
          alert(`Contractor action: ${name}`);
        }
      };

      return (
        <div className="w-full bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
          <div className="flex items-center gap-3">
            {imageUrl ? (
              <img src={imageUrl} alt={name} className="w-10 h-10 rounded-full object-cover" />
            ) : (
              <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">👷</div>
            )}
            <div>
              <div className="text-sm font-semibold text-gray-800">{name}</div>
              <div className="text-xs text-gray-500 capitalize">Status: {statusText}</div>
            </div>
          </div>
          <div className="mt-3">
            <div className="flex items-center justify-between text-xs text-gray-600 mb-1">
              <span>{formatCurrency(spentToDate, 'USD')}</span>
              <span>{formatCurrency(allocatedBudget, 'USD')}</span>
            </div>
            <div className="w-full h-2 bg-gray-100 rounded">
              <div className="h-2 bg-blue-600 rounded" style={{ width: `${pct}%` }}></div>
            </div>
            <div className="mt-2 text-xs text-gray-500">
              {nextPaymentDue ? <>Next due: <span className="font-medium text-gray-700">{nextPaymentDue}</span></> : 'No upcoming payments'}
            </div>
          </div>
          <div className="mt-3">
            <button onClick={onAction} className="text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-50">Update status</button>
          </div>
        </div>
      );
    };

    const RenovationBudgetDashboard = (props) => {
      const {
        totalBudget = 0,
        totalActual,
        currency = 'USD',
        lineItems = [],
        payments = [],
        contractors = [],
        chartMode = 'by_line_item',
        dateFormat = 'iso',
        overdueThresholdDays = 7,
        selectLineItemAction,
        paymentAction,
        updateContractorStatusAction
      } = props;

      const contractorsMap = useMemo(() => {
        const map = {};
        contractors.forEach(c => { map[c.id] = c; });
        return map;
      }, [contractors]);

      const computedTotalActual = useMemo(() => {
        if (typeof totalActual === 'number') return totalActual;
        return lineItems.reduce((sum, li) => sum + (Number(li.actual) || 0), 0);
      }, [totalActual, lineItems]);

      const remaining = Math.max(0, (totalBudget || 0) - (computedTotalActual || 0));

      const chartItems = useMemo(() => {
        if (chartMode === 'by_contractor') {
          const agg = {};
          lineItems.forEach(li => {
            const contractorId = li.contractorId || li.contractorName || 'unassigned';
            const label = contractorsMap[contractorId]?.name || li.contractorName || (contractorId === 'unassigned' ? 'Unassigned' : contractorId);
            if (!agg[contractorId]) {
              agg[contractorId] = { id: contractorId, name: label, estimate: 0, actual: 0 };
            }
            agg[contractorId].estimate += Number(li.estimate) || 0;
            agg[contractorId].actual += Number(li.actual) || 0;
          });
          return Object.values(agg);
        } else {
          return lineItems.map(li => ({
            id: li.id,
            name: li.name,
            estimate: Number(li.estimate) || 0,
            actual: Number(li.actual) || 0,
            contractorName: li.contractorId ? (contractorsMap[li.contractorId]?.name || '') : (li.contractorName || '')
          }));
        }
      }, [chartMode, lineItems, contractorsMap]);

      const contractorCards = useMemo(() => {
        return contractors.map(c => ({
          id: c.id,
          name: c.name,
          status: typeof c.status === 'string' ? c.status : c.status,
          allocatedBudget: Number(c.allocatedBudget) || 0,
          spentToDate: Number(c.spentToDate) || 0,
          nextPaymentDue: c.nextPaymentDue
        }));
      }, [contractors]);

      const locale = dateFormat === 'local' ? undefined : 'en-US';

      return (
        <div className="w-full bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-lg font-semibold text-gray-800">Renovation Budget Dashboard</h2>
              <div className="text-sm text-gray-500">Totals in {currency} • Dates: {dateFormat.toUpperCase()}</div>
            </div>
            <div className="text-right">
              <div className="text-sm text-gray-600">Total Budget</div>
              <div className="text-base font-semibold">{formatCurrency(totalBudget, currency)}</div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div className="lg:col-span-8 space-y-4">
              <RemainingBudgetIndicator
                totalBudget={totalBudget}
                totalActual={computedTotalActual}
                remaining={remaining}
                currency={currency}
                trend="flat"
              />
              <div className="flex items-center justify-between">
                <div className="text-sm text-gray-600">Chart mode: <span className="font-medium">{chartMode === 'by_contractor' ? 'By contractor' : 'By line item'}</span></div>
                <div className="text-xs text-gray-400">Tap a bar to select an item</div>
              </div>
              <BudgetVsActualBarChart
                items={chartItems}
                currencyCode={currency}
                variant="grouped"
                sortBy="variance"
                sortOrder="asc"
                showVariance={true}
                highlightOverBudget={true}
                overBudgetThresholdPct={0}
                maxVisibleItems={100}
                tooltipMode="detailed"
                locale={locale || 'en-US'}
                onItemSelectAction={selectLineItemAction}
              />
            </div>
            <div className="lg:col-span-4 space-y-3">
              <div className="text-sm font-semibold text-gray-700">Contractors</div>
              {contractorCards.length === 0 ? (
                <div className="text-sm text-gray-500 bg-gray-50 border border-gray-200 rounded p-3">No contractors added.</div>
              ) : contractorCards.map((c) => (
                <ContractorCard key={c.id} {...c} action={updateContractorStatusAction} />
              ))}
            </div>
          </div>

          <div className="mt-6">
            <PaymentScheduleTable
              payments={payments.map(p => ({
                ...p,
                contractorName: contractorsMap[p.contractorId]?.name || p.contractorName || p.contractorId
              }))}
              currency={currency}
              defaultSort={{ by: 'dueDate', direction: 'asc' }}
              highlightOverdue={true}
              showTotalsRow={true}
              overdueThresholdDays={overdueThresholdDays}
            />
          </div>
        </div>
      );
    };

    // Registry
    const ComponentRegistry = {
      RenovationBudgetDashboard: RenovationBudgetDashboard,
      BudgetVsActualBarChart: BudgetVsActualBarChart,
      PaymentScheduleTable: PaymentScheduleTable,
      ContractorCard: ContractorCard,
      RemainingBudgetIndicator: RemainingBudgetIndicator
    };

    const ComponentRenderer = ({ componentName, props }) => {
      const Component = ComponentRegistry[componentName];

      if (!Component) {
        return (
          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">Component "{componentName}" not found</p>
          </div>
        );
      }

      return <Component {...props} />;
    };

    const ContentChunkRenderer = ({ chunk }) => {
      if (!chunk) return null;
      if (typeof chunk === 'string') {
        return <p className="whitespace-pre-wrap text-gray-800">{chunk}</p>;
      }
      if (chunk.type === 'text') {
        const parts = String(chunk.text || '').split('\n\n');
        return (
          <div className="space-y-3">
            {parts.map((p, idx) => <p key={idx} className="whitespace-pre-wrap text-gray-800">{p}</p>)}
          </div>
        );
      }
      if (chunk.type === 'component' && chunk.component?.name) {
        const { name, props } = chunk.component;
        return <ComponentRenderer componentName={name} props={props || {}} />;
      }
      return (
        <div className="text-sm text-gray-500">Unsupported content</div>
      );
    };

    const MessageBubble = ({ role, content }) => {
      const isUser = role === 'user';
      const containerClass = isUser ? 'items-end' : 'items-start';
      const bubbleClass = isUser ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-200';
      const avatar = isUser ? '🧑' : '🤖';

      const contentArray = Array.isArray(content) ? content : [{ type: 'text', text: String(content || '') }];

      return (
        <div className={`w-full flex ${containerClass} mb-4`}>
          <div className="flex items-start gap-3 w-full">
            <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-lg">{avatar}</div>
            <div className="flex-1 space-y-3">
              {contentArray.map((chunk, idx) => (
                <div key={idx} className={`rounded-lg p-3 ${chunk?.type === 'component' ? 'bg-transparent border-0 p-0' : bubbleClass}`}>
                  <ContentChunkRenderer chunk={chunk} />
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const ConversationView = ({ conversation = [] }) => {
      return (
        <div className="max-w-6xl mx-auto px-4 py-6">
          <h1 className="text-2xl font-semibold text-gray-900 mb-6">Conversation Viewer</h1>
          {Array.isArray(conversation) && conversation.length > 0 ? (
            conversation.map((msg, idx) => (
              <MessageBubble key={idx} role={msg.role} content={msg.content} />
            ))
          ) : (
            <div className="text-gray-600">No conversation data.</div>
          )}
        </div>
      );
    };

    const rootEl = document.getElementById("root");
    if (rootEl) {
      const root = createRoot(rootEl);
      root.render(<ConversationView conversation={conversationData} />);
    }
  </script>
</body>
</html>