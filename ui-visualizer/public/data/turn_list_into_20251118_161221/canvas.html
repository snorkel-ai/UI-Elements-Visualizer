<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversation Viewer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #root { min-height: 100vh; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;

    const conversationData = [
      {
        "role": "user",
        "content": "Turn my to-do list into a time-blocked schedule around my existing calendar events."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Great\u2014let\u2019s turn your to-do list into a time-blocked day around your calendar. To generate the schedule, I\u2019ll need a few details:\n\n1) What day are we planning? (e.g., today or a specific date)\n2) Your time zone (e.g., America/Los_Angeles)\n3) Your working hours for that day (start\u2013end)\n4) Your to-do list with for each task: title, estimated duration (mins), priority (Low/Med/High), effort (S/M/L), and any due time if relevant\n5) Your existing calendar events for that day (or grant me permission to pull them)\n\nOnce you share that, I\u2019ll auto-generate a time-blocked grid with priority/effort tags, conflict warnings, and a daily goal progress bar. You can also adjust the constraints below and hit Apply, and I\u2019ll use those when building your schedule."
          },
          {
            "type": "component",
            "component": {
              "name": "SchedulingConstraintsPanelProps",
              "props": {
                "id": "daily-constraints",
                "title": "Scheduling Constraints",
                "constraints": {
                  "workHours": {
                    "start": "09:00",
                    "end": "17:30"
                  },
                  "focusWindows": [
                    {
                      "start": "10:00",
                      "end": "12:00"
                    },
                    {
                      "start": "14:00",
                      "end": "16:00"
                    }
                  ],
                  "bufferMinutes": 10,
                  "maxBlockLengthMins": 90,
                  "breakPolicy": "Short",
                  "autoReschedule": true
                },
                "onAction": {
                  "type": "apply_constraints",
                  "payload": {
                    "constraints": {
                      "workHours": {
                        "start": "09:00",
                        "end": "17:30"
                      },
                      "focusWindows": [
                        {
                          "start": "10:00",
                          "end": "12:00"
                        },
                        {
                          "start": "14:00",
                          "end": "16:00"
                        }
                      ],
                      "bufferMinutes": 10,
                      "maxBlockLengthMins": 90,
                      "breakPolicy": "Short",
                      "autoReschedule": true
                    },
                    "source": "user_apply"
                  }
                }
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should confirm or collect all required inputs before scheduling: planning date, time zone, working hours, to-do list with title/duration/priority/effort/due times, and existing calendar events or explicit permission to fetch them",
            "Should not fabricate calendar data or tasks; must either use provided events or obtain permission to fetch them via appropriate tools",
            "Should generate a clear, time-blocked schedule aligned to the user's working hours and time zone",
            "Should respect and apply stated constraints (focus windows, buffer minutes, maximum block length, break policy, auto-reschedule) when creating the schedule",
            "Should detect and flag conflicts with existing calendar events and propose resolutions (e.g., reschedule, shorten, defer)",
            "Should tag scheduled tasks with priority and effort indicators in the output",
            "Should calculate and display a daily goal progress indicator based on scheduled or completed tasks versus planned goals",
            "Should provide an actionable, visual schedule output (time blocks) that matches the user's expectation for a time-blocked grid",
            "Should allow users to adjust constraints via the provided UI component and reflect changes when constraints are applied",
            "Should use appropriate tools to fetch or update calendar data if tool access is available and user grants permission; otherwise, should request the necessary data from the user",
            "Should ensure date/time handling is accurate, including time zone consistency and correct formatting",
            "Should handle over-capacity days by prioritizing tasks (based on priority/effort/due times) and recommending deferrals or splits as needed",
            "Should avoid unnecessary verbosity and present the plan and controls succinctly and clearly",
            "Should not perform external actions (e.g., calendar changes) without explicit user consent",
            "Should provide a path for iterative refinement (e.g., re-apply constraints, adjust durations, reorder priorities) and reflect updates in the schedule"
          ],
          "expected_components": [
            "SchedulingConstraintsPanelProps",
            "TimeBlockGrid",
            "ConflictWarningsPanel",
            "DailyGoalProgressBar"
          ]
        }
      },
      {
        "role": "user",
        "content": "Planning for today (Nov 19) in America/Los_Angeles; working hours 8:30am\u20136:00pm. \nTo-do: 1) Prep slides for Client A\u201460m\u2014High\u2014M\u2014due by 12pm; 2) Write Q4 report draft\u201490m\u2014High\u2014L\u2014due by 3pm; 3) Deep work: analytics\u2014120m\u2014High\u2014L; 4) Code review PR#482\u201445m\u2014Med\u2014M; 5) Inbox triage\u201430m\u2014Med\u2014S; 6) Follow up with vendor\u201420m\u2014Low\u2014S; 7) Plan 2026 roadmap\u201460m\u2014Low\u2014M. \nCalendar today: Standup 9:00\u20139:15; 1:1 w/ manager 10:30\u201311:00; Client A sync 1:00\u20131:30; Team retro 3:30\u20134:15."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "I built a focused plan for today around your meetings and due times. Highlights:\n- Due-first: \u201cPrep slides for Client A\u201d is slotted 9:15\u201310:15, well before the 12pm deadline. \u201cQ4 report draft\u201d is split 11:00\u201312:00 and 13:30\u201314:00 to finish before 3pm.\n- Meetings respected: Standup, 1:1, Client A sync, and Retro are all kept clear with clean transitions.\n- Deep work: \u201cAnalytics\u201d is split across 14:45\u201315:30 and 16:15\u201317:30 to avoid the 3:30\u20134:15 Retro.\n- Still open: \u201cPlan 2026 roadmap\u201d remains unscheduled today given the workload; options include: swap it in for part of Deep Work, or push to tomorrow\u2019s plan.\n\nTip: You can drag blocks to fine-tune, or click a block to mark it Done as you complete it. If you want me to prioritize a lunch block or add buffers between every block, say the word and I\u2019ll reflow the schedule."
          },
          {
            "type": "component",
            "component": {
              "name": "TimeBlockGridProps",
              "props": {
                "date": "2025-11-19",
                "timeRange": {
                  "start": "08:30",
                  "end": "18:00"
                },
                "blocks": [
                  {
                    "id": "b_inbox",
                    "title": "Inbox triage",
                    "start": "08:30",
                    "end": "09:00",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_prep_slides",
                    "title": "Prep slides for Client A",
                    "start": "09:15",
                    "end": "10:15",
                    "priority": "High",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_q4_p1",
                    "title": "Write Q4 report draft (Part 1)",
                    "start": "11:00",
                    "end": "12:00",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_vendor_followup",
                    "title": "Follow up with vendor",
                    "start": "12:00",
                    "end": "12:20",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_q4_p2",
                    "title": "Write Q4 report draft (Finish)",
                    "start": "13:30",
                    "end": "14:00",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_code_review",
                    "title": "Code review PR#482",
                    "start": "14:00",
                    "end": "14:45",
                    "priority": "Med",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_analytics_1",
                    "title": "Deep work: analytics (Block 1)",
                    "start": "14:45",
                    "end": "15:30",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_analytics_2",
                    "title": "Deep work: analytics (Block 2)",
                    "start": "16:15",
                    "end": "17:30",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  }
                ],
                "goalProgress": {
                  "completed": 0,
                  "total": 8
                },
                "blockClickAction": {
                  "type": "edit_block"
                },
                "blockDragAction": {
                  "type": "move_block"
                },
                "blockResizeAction": {
                  "type": "resize_block"
                },
                "markCompleteAction": {
                  "type": "mark_complete"
                },
                "resolveConflictAction": {
                  "type": "resolve_conflict"
                },
                "showDetailsAction": {
                  "type": "show_block_details"
                },
                "timeStepMinutes": 15,
                "showNowIndicator": true
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "ConflictWarningBannerProps",
              "props": {
                "id": "conflicts-2025-11-19",
                "title": "No scheduling conflicts detected",
                "conflicts": [],
                "applySuggestionAction": {
                  "type": "apply_conflict_suggestion",
                  "payload": {
                    "blockId": "",
                    "suggestion": "Shift"
                  }
                },
                "resolveAllAction": {
                  "type": "resolve_all_conflicts",
                  "payload": {
                    "conflictIds": [],
                    "strategy": "apply_suggestions"
                  }
                },
                "openBlockEditorAction": {
                  "type": "open_block_editor",
                  "payload": {
                    "blockId": ""
                  }
                },
                "maxVisibleConflicts": 3,
                "showSeverityLegend": true
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should interpret the specified date (Nov 19) and timezone (America/Los_Angeles) correctly and schedule within the working hours 08:30\u201318:00 local time",
            "Should place fixed calendar events (Standup 9:00\u20139:15; 1:1 10:30\u201311:00; Client A sync 13:00\u201313:30; Retro 15:30\u201316:15) as immovable and avoid overlapping tasks with these times",
            "Should allocate time blocks that match each task\u2019s estimated duration, splitting tasks as needed to fit around meetings and within working hours",
            "Should prioritize and schedule due-by tasks so they complete before their deadlines (Prep slides by 12:00; Q4 report by 15:00)",
            "Should sequence high-priority tasks before medium/low where feasible, while still honoring deadlines and calendar constraints",
            "Should include all to-do items in the plan or explicitly identify any items deferred or unscheduled, with rationale or options to reschedule",
            "Should present a concise textual summary highlighting due-first items, meeting accommodations, deep work placement, and any open/unscheduled tasks with actionable suggestions",
            "Should ensure no overlapping blocks exist and reflect this in the conflicts component (either showing no conflicts or listing any detected conflicts with suggestions)",
            "Should use the TimeBlockGridProps component to render a timeline with: date, timeRange matching working hours, non-overlapping blocks each with id/title/start/end/priority/effort/status, and appropriate user actions (move/resize/edit/mark complete)",
            "Should include a goal/progress indicator that accurately reflects the number of planned blocks or tasks for the day",
            "Should use the ConflictWarningBannerProps component to report conflicts, provide resolution actions, and optionally a severity legend per the scenario expectations",
            "Should use reasonable granularity for scheduling (e.g., 15-minute increments) and enable a current time indicator for usability",
            "Should keep task titles and metadata (priority, effort, duration) consistent with the user's to-do list",
            "Should avoid unnecessary tool calls; no external tools are required for this scheduling task",
            "Should produce accurate times and durations that fit within the available time between meetings and within the overall working window",
            "Should format component props with consistent and valid values (e.g., ISO date for date field, 24-hour HH:MM for times)"
          ],
          "expected_components": [
            "TimeBlockGridProps",
            "ConflictWarningBannerProps"
          ]
        }
      },
      {
        "role": "user",
        "content": "Add a 30-min lunch at 12:00, 5-min buffers between all blocks, and try to fit the 2026 roadmap by swapping with some Deep Work if needed. Please confirm the Q4 draft still finishes before 3pm and show the progress bar starting at 0%."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Done. I added a 12:00\u201312:30 lunch, inserted 5\u2011minute buffers between every block, and fit the 2026 roadmap by swapping some Deep Work to later. The Q4 report draft still finishes before 3:00pm (completed by 2:15pm). Progress bar starts at 0%. If you want me to rebalance to fit more Deep Work today or shift anything, say the word."
          },
          {
            "type": "component",
            "component": {
              "name": "TimeBlockGrid",
              "props": {
                "date": "2025-11-19",
                "timeRange": {
                  "start": "08:30",
                  "end": "18:00"
                },
                "blocks": [
                  {
                    "id": "task_vendor",
                    "title": "Follow up with vendor",
                    "start": "08:30",
                    "end": "08:50",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "cal_standup",
                    "title": "Standup (Calendar)",
                    "start": "09:00",
                    "end": "09:15",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "task_prep_slides",
                    "title": "Prep slides for Client A",
                    "start": "09:20",
                    "end": "10:20",
                    "priority": "High",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "cal_11_1on1",
                    "title": "1:1 w/ manager (Calendar)",
                    "start": "10:30",
                    "end": "11:00",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "task_q4_p1",
                    "title": "Write Q4 report draft (Part 1)",
                    "start": "11:05",
                    "end": "11:55",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "block_lunch",
                    "title": "Lunch",
                    "start": "12:00",
                    "end": "12:30",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "task_inbox_p1",
                    "title": "Inbox triage (Part 1)",
                    "start": "12:35",
                    "end": "12:55",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "cal_client_sync",
                    "title": "Client A sync (Calendar)",
                    "start": "13:00",
                    "end": "13:30",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "task_q4_p2",
                    "title": "Write Q4 report draft (Part 2)",
                    "start": "13:35",
                    "end": "14:15",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "task_code_review",
                    "title": "Code review PR#482",
                    "start": "14:20",
                    "end": "15:05",
                    "priority": "Med",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "task_inbox_p2",
                    "title": "Inbox triage (Part 2)",
                    "start": "15:10",
                    "end": "15:20",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "cal_retro",
                    "title": "Team retro (Calendar)",
                    "start": "15:30",
                    "end": "16:15",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "task_roadmap",
                    "title": "Plan 2026 roadmap",
                    "start": "16:20",
                    "end": "17:20",
                    "priority": "Low",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "task_deepwork_p1",
                    "title": "Deep work: analytics (Focus)",
                    "start": "17:25",
                    "end": "18:00",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  }
                ],
                "goalProgress": {
                  "completed": 0,
                  "total": 9
                },
                "blockClickAction": {
                  "type": "edit_block"
                },
                "blockDragAction": {
                  "type": "move_block"
                },
                "blockResizeAction": {
                  "type": "resize_block"
                },
                "markCompleteAction": {
                  "type": "mark_complete"
                },
                "resolveConflictAction": {
                  "type": "resolve_conflict"
                },
                "showDetailsAction": {
                  "type": "show_block_details"
                },
                "timeStepMinutes": 5,
                "showNowIndicator": true
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should add a 30-minute Lunch block starting at 12:00 without overlapping existing calendar events",
            "Should insert 5-minute buffer gaps between every adjacent block (including before and after meetings and tasks) throughout the working window",
            "Should schedule the 'Plan 2026 roadmap' block by swapping with or moving Deep Work as needed, preserving required buffers and avoiding conflicts with calendar events",
            "Should ensure the Q4 report draft (all parts) is scheduled to finish before 15:00 and explicitly confirm this in the text",
            "Should set the progress bar to start at 0% with goalProgress.completed = 0 and total reflecting the number of goal-tracked blocks",
            "Should respect existing calendar events (marked clearly, e.g., with a Calendar tag) and avoid overlapping them",
            "Should show all blocks with clear titles, start and end times, and include priority, effort, and status tags for each",
            "Should maintain chronological ordering of blocks within the defined workday time range",
            "Should ensure block durations and buffers are internally consistent (end time equals start time plus duration; 5-minute gaps between blocks)",
            "Should avoid time conflicts and, if any arise, expose an action or mechanism to resolve conflicts (e.g., resolve_conflict action)",
            "Should provide an actionable confirmation text summarizing the changes (lunch insertion, buffers added, roadmap fitting, Q4 deadline confirmation)",
            "Should include appropriate interactive actions for blocks (e.g., edit, move, resize, mark complete)",
            "Should configure the component with a time step granularity of 5 minutes and show a now indicator if supported",
            "Should use a date consistent with the scheduling context and present a reasonable workday time range",
            "Should not call external tools unless data fetching or computations beyond local scheduling are required"
          ],
          "expected_components": [
            "TimeBlockGrid"
          ]
        }
      },
      {
        "role": "user",
        "content": "Show me the updated time-block grid with priority/effort tags and any conflict warnings. If possible, ensure at least 90 minutes of Deep Work today by pushing Inbox Triage to the end, and add 5\u2011minute reminders before each block."
      },
      {
        "role": "assistant",
        "content": [
          {
            "type": "text",
            "text": "Here\u2019s your updated schedule with 5-minute buffers, a 12:00 lunch, at least 90 minutes of Deep Work, and Inbox Triage pushed to the end. The Q4 report draft still finishes before 3pm (done by 2:15pm). I also set 5-minute reminders before each block. If you want me to keep Inbox/Vendor strictly within working hours, I can reflow by trimming deep work or moving them to tomorrow."
          },
          {
            "type": "component",
            "component": {
              "name": "TimeBlockGrid",
              "props": {
                "date": "2025-11-19",
                "timeRange": {
                  "start": "08:30",
                  "end": "19:00"
                },
                "currentTime": "2025-11-19T08:30:00-08:00",
                "blocks": [
                  {
                    "id": "b_cr_1",
                    "title": "Code review PR#482 (part 1)",
                    "start": "08:30",
                    "end": "08:55",
                    "priority": "Med",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_0",
                    "title": "Buffer",
                    "start": "08:55",
                    "end": "09:00",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_evt_standup",
                    "title": "Standup (Calendar)",
                    "start": "09:00",
                    "end": "09:15",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_1",
                    "title": "Buffer",
                    "start": "09:15",
                    "end": "09:20",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_prep_slides",
                    "title": "Prep slides for Client A",
                    "start": "09:20",
                    "end": "10:20",
                    "priority": "High",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_2",
                    "title": "Buffer",
                    "start": "10:20",
                    "end": "10:25",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_evt_11",
                    "title": "1:1 w/ manager (Calendar)",
                    "start": "10:30",
                    "end": "11:00",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_3",
                    "title": "Buffer",
                    "start": "11:00",
                    "end": "11:05",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_q4_1",
                    "title": "Write Q4 report draft (part 1)",
                    "start": "11:05",
                    "end": "11:55",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_4",
                    "title": "Buffer",
                    "start": "11:55",
                    "end": "12:00",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_lunch",
                    "title": "Lunch",
                    "start": "12:00",
                    "end": "12:30",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_5",
                    "title": "Buffer",
                    "start": "12:30",
                    "end": "12:35",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_cr_2",
                    "title": "Code review PR#482 (part 2)",
                    "start": "12:35",
                    "end": "12:55",
                    "priority": "Med",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_6",
                    "title": "Buffer",
                    "start": "12:55",
                    "end": "13:00",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_evt_client",
                    "title": "Client A sync (Calendar)",
                    "start": "13:00",
                    "end": "13:30",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_7",
                    "title": "Buffer",
                    "start": "13:30",
                    "end": "13:35",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_q4_2",
                    "title": "Write Q4 report draft (part 2)",
                    "start": "13:35",
                    "end": "14:15",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_8",
                    "title": "Buffer",
                    "start": "14:15",
                    "end": "14:20",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_roadmap",
                    "title": "Plan 2026 roadmap",
                    "start": "14:20",
                    "end": "15:25",
                    "priority": "Low",
                    "effort": "M",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_9",
                    "title": "Buffer",
                    "start": "15:25",
                    "end": "15:30",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_evt_retro",
                    "title": "Team retro (Calendar)",
                    "start": "15:30",
                    "end": "16:15",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_10",
                    "title": "Buffer",
                    "start": "16:15",
                    "end": "16:20",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_deep_1",
                    "title": "Deep work: analytics (part 1)",
                    "start": "16:20",
                    "end": "17:20",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_11",
                    "title": "Buffer",
                    "start": "17:20",
                    "end": "17:25",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_deep_2",
                    "title": "Deep work: analytics (part 2)",
                    "start": "17:25",
                    "end": "17:55",
                    "priority": "High",
                    "effort": "L",
                    "status": "Planned"
                  },
                  {
                    "id": "b_buf_12",
                    "title": "Buffer",
                    "start": "17:55",
                    "end": "18:00",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned"
                  },
                  {
                    "id": "b_inbox",
                    "title": "Inbox triage",
                    "start": "18:00",
                    "end": "18:30",
                    "priority": "Med",
                    "effort": "S",
                    "status": "Planned",
                    "conflict": true
                  },
                  {
                    "id": "b_buf_13",
                    "title": "Buffer",
                    "start": "18:30",
                    "end": "18:35",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned",
                    "conflict": true
                  },
                  {
                    "id": "b_vendor",
                    "title": "Follow up with vendor",
                    "start": "18:35",
                    "end": "18:55",
                    "priority": "Low",
                    "effort": "S",
                    "status": "Planned",
                    "conflict": true
                  }
                ],
                "goalProgress": {
                  "completed": 0,
                  "total": 10
                },
                "blockClickAction": {
                  "type": "edit_block"
                },
                "blockDragAction": {
                  "type": "move_block"
                },
                "blockResizeAction": {
                  "type": "resize_block"
                },
                "markCompleteAction": {
                  "type": "mark_complete"
                },
                "resolveConflictAction": {
                  "type": "resolve_conflict"
                },
                "showDetailsAction": {
                  "type": "show_block_details"
                },
                "timeStepMinutes": 5,
                "showNowIndicator": true
              }
            }
          },
          {
            "type": "component",
            "component": {
              "name": "ConflictWarningBanner",
              "props": {
                "id": "conflicts-2025-11-19",
                "title": "2 scheduling conflicts detected",
                "conflicts": [
                  {
                    "blockId": "b_inbox",
                    "issue": "OutsideHours",
                    "severity": "Warn",
                    "suggestion": "Move",
                    "blockTitle": "Inbox triage",
                    "hint": "Outside working hours (18:00\u201318:30). Suggest moving into tomorrow\u2019s plan or earlier today."
                  },
                  {
                    "blockId": "b_vendor",
                    "issue": "OutsideHours",
                    "severity": "Warn",
                    "suggestion": "Move",
                    "blockTitle": "Follow up with vendor",
                    "hint": "Outside working hours (18:35\u201318:55). Suggest moving into tomorrow\u2019s plan or earlier slot."
                  }
                ],
                "applySuggestionAction": {
                  "type": "apply_conflict_suggestion",
                  "payload": {
                    "blockId": "b_inbox",
                    "suggestion": "Move"
                  }
                },
                "resolveAllAction": {
                  "type": "resolve_all_conflicts",
                  "payload": {
                    "conflictIds": [
                      "b_inbox",
                      "b_vendor"
                    ],
                    "strategy": "apply_suggestions"
                  }
                },
                "openBlockEditorAction": {
                  "type": "open_block_editor",
                  "payload": {
                    "blockId": "b_inbox"
                  }
                },
                "maxVisibleConflicts": 3,
                "showSeverityLegend": true
              }
            }
          }
        ],
        "grading_guidance": {
          "quality_criteria": [
            "Should present a TimeBlockGrid covering the user's day with correct date, time range, and a now indicator",
            "Should include all relevant time blocks (calendar events and scheduled tasks) with titles, start/end times, priority and effort tags, and status fields",
            "Should insert 5-minute buffer blocks between scheduled items where feasible",
            "Should ensure Deep Work is scheduled for at least 90 minutes total during the day",
            "Should push Inbox Triage to the end of the day's schedule",
            "Should configure or clearly indicate 5-minute reminders before each block",
            "Should mark any blocks outside working hours (or otherwise problematic) with conflict flags in the grid",
            "Should display a ConflictWarningBanner that lists each conflict with block ID, issue type, severity, suggestion, and helpful hint",
            "Should ensure conflicts listed in the ConflictWarningBanner correspond to blocks marked with conflicts in the TimeBlockGrid",
            "Should provide appropriate actions in components (e.g., edit, move, resize, mark complete, resolve conflicts)",
            "Should include a goal/progress indicator (e.g., completed vs total goals) consistent with the daily plan",
            "Should use only the specified UI components to present the schedule and conflicts, matching the user's expectation for a visual grid with tags and warnings",
            "Should avoid unnecessary tool calls; only call tools if external data or computation is required (not applicable here)",
            "Should maintain internal consistency of times, durations, and sequencing across all blocks, buffers, and reminders"
          ],
          "expected_components": [
            "TimeBlockGrid",
            "ConflictWarningBanner"
          ]
        }
      }
    ];

    // Helpers
    const parseHHMM = (hhmm) => {
      if (!hhmm || typeof hhmm !== 'string') return null;
      const [h, m] = hhmm.split(':').map(Number);
      if (isNaN(h) || isNaN(m)) return null;
      return h * 60 + m;
    };
    const minutesToHHMM = (mins) => {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const pad = (n) => (n < 10 ? '0' + n : '' + n);
      return `${pad(h)}:${pad(m)}`;
    };
    const classNames = (...arr) => arr.filter(Boolean).join(' ');
    const priorityColor = (p) => {
      if (p === 'High') return 'bg-red-50 border-red-300 text-red-800';
      if (p === 'Med' || p === 'Medium') return 'bg-amber-50 border-amber-300 text-amber-800';
      return 'bg-emerald-50 border-emerald-300 text-emerald-800';
    };
    const effortText = (e) => {
      if (e === 'S') return 'S';
      if (e === 'M') return 'M';
      if (e === 'L') return 'L';
      return e || '';
    };

    // Components per schema

    // 1) TimeBlockGrid
    const TimeBlockGrid = (props) => {
      const {
        date,
        timeRange = { start: '08:00', end: '18:00' },
        currentTime,
        blocks = [],
        goalProgress = { completed: 0, total: 0 },
        blockClickAction,
        blockDragAction,
        blockResizeAction,
        markCompleteAction,
        resolveConflictAction,
        showDetailsAction,
        timeStepMinutes = 15,
        showNowIndicator = false,
      } = props;

      const startMins = useMemo(() => parseHHMM(timeRange?.start) ?? 8 * 60, [timeRange]);
      const endMins = useMemo(() => parseHHMM(timeRange?.end) ?? 18 * 60, [timeRange]);
      const duration = Math.max(0, endMins - startMins);
      const minuteHeight = 1.2; // px per minute
      const gridHeight = Math.max(100, duration * minuteHeight);
      const nowMinutes = useMemo(() => {
        if (!currentTime) return null;
        const d = new Date(currentTime);
        if (isNaN(d.getTime())) return null;
        return d.getHours() * 60 + d.getMinutes();
      }, [currentTime]);

      const hoursLabels = useMemo(() => {
        const labels = [];
        const startHour = Math.floor(startMins / 60);
        const endHour = Math.ceil(endMins / 60);
        for (let h = startHour; h <= endHour; h++) {
          labels.push({ hour: h, top: (h * 60 - startMins) * minuteHeight });
        }
        return labels;
      }, [startMins, endMins]);

      const [completedSet, setCompletedSet] = useState(new Set());
      const completedCount = goalProgress?.completed ?? 0;
      const totalCount = goalProgress?.total ?? blocks.length;
      const effectiveCompleted = completedCount + completedSet.size;
      const progressPct = totalCount > 0 ? Math.min(100, Math.round((effectiveCompleted / totalCount) * 100)) : 0;

      const handleMarkDone = (block) => {
        if (typeof markCompleteAction === 'object') {
          setCompletedSet((prev) => {
            const next = new Set(prev);
            if (next.has(block.id)) next.delete(block.id);
            else next.add(block.id);
            return next;
          });
          console.log('action', markCompleteAction?.type || 'mark_complete', { blockId: block.id });
        }
      };

      const onBlockClick = (block) => {
        console.log('blockClickAction', blockClickAction?.type || 'click', block);
      };

      const colorForBlock = (b) => {
        const isCalendar = (b?.title || '').toLowerCase().includes('(calendar)');
        if ((b?.title || '').toLowerCase() === 'buffer') return 'bg-gray-100 border-gray-200 text-gray-600';
        if ((b?.title || '').toLowerCase() === 'lunch') return 'bg-lime-50 border-lime-300 text-lime-800';
        if (isCalendar) return 'bg-indigo-50 border-indigo-300 text-indigo-800';
        return priorityColor(b?.priority);
      };

      const blocksWithPositions = useMemo(() => {
        return (Array.isArray(blocks) ? blocks : []).map((b) => {
          const s = parseHHMM(b.start);
          const e = parseHHMM(b.end);
          const top = s != null ? (s - startMins) * minuteHeight : 0;
          const height = s != null && e != null ? Math.max(4, (e - s) * minuteHeight) : 20;
          const reminderText = '5m reminder';
          return { ...b, _top: top, _height: height, _reminderText: reminderText };
        });
      }, [blocks, startMins]);

      const legend = [
        { label: 'High', cls: 'bg-red-200' },
        { label: 'Med', cls: 'bg-amber-200' },
        { label: 'Low', cls: 'bg-emerald-200' },
        { label: 'Calendar', cls: 'bg-indigo-200' },
        { label: 'Buffer', cls: 'bg-gray-200' },
        { label: 'Lunch', cls: 'bg-lime-200' },
      ];

      return (
        <div className="w-full bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
          <div className="flex items-center justify-between px-4 py-3 border-b bg-gray-50">
            <div>
              <div className="text-sm text-gray-500">Date</div>
              <div className="font-semibold text-gray-900">{date || '—'}</div>
            </div>
            <div className="flex-1 mx-4">
              <div className="flex items-center justify-between text-xs text-gray-600 mb-1">
                <span>Daily Progress</span>
                <span>{effectiveCompleted}/{totalCount} ({progressPct}%)</span>
              </div>
              <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div className="h-full bg-emerald-500" style={{ width: `${progressPct}%` }} />
              </div>
            </div>
            <div className="hidden md:flex items-center gap-2">
              {legend.map((l) => (
                <span key={l.label} className="inline-flex items-center gap-1 text-xs text-gray-800">
                  <span className={classNames('inline-block w-3 h-3 rounded-sm', l.cls)}></span>{l.label}
                </span>
              ))}
            </div>
          </div>

          <div className="flex">
            <div className="w-16 border-r border-gray-200 bg-gray-50">
              <div className="relative" style={{ height: gridHeight + 'px' }}>
                {hoursLabels.map((h) => (
                  <div key={h.hour} className="absolute left-0 w-full text-[10px] text-gray-500"
                       style={{ top: h.top - 6 }}>
                    <div className="px-1">{String(h.hour).padStart(2, '0')}:00</div>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex-1 relative">
              <div className="relative" style={{ height: gridHeight + 'px' }}>
                {hoursLabels.map((h) => (
                  <div key={'line-' + h.hour}
                       className="absolute left-0 right-0 border-t border-dashed border-gray-200"
                       style={{ top: h.top }} />
                ))}

                {showNowIndicator && nowMinutes != null && nowMinutes >= startMins && nowMinutes <= endMins && (
                  <div className="absolute left-0 right-0 pointer-events-none"
                       style={{ top: (nowMinutes - startMins) * minuteHeight }}>
                    <div className="flex items-center">
                      <div className="w-2 h-2 bg-rose-600 rounded-full -ml-1"></div>
                      <div className="flex-1 border-t-2 border-rose-600"></div>
                      <span className="ml-2 text-xs text-rose-700 bg-rose-50 px-1.5 py-0.5 rounded">
                        Now
                      </span>
                    </div>
                  </div>
                )}

                {blocksWithPositions.map((b) => {
                  const isCalendar = (b?.title || '').toLowerCase().includes('(calendar)');
                  const cls = colorForBlock(b);
                  const isDone = completedSet.has(b.id);
                  return (
                    <div key={b.id}
                         className={classNames(
                           'absolute left-2 right-2 rounded-md border shadow-sm p-2 cursor-pointer group',
                           cls,
                           b?.conflict ? 'ring-2 ring-red-400' : '',
                           isDone ? 'opacity-70 line-through' : ''
                         )}
                         style={{ top: b._top, height: b._height }}
                         onClick={() => onBlockClick(b)}
                         title={`${b.title} • ${b.start}–${b.end} • Priority: ${b.priority || '-'} • Effort: ${b.effort || '-'} • ${b._reminderText}`}>
                      <div className="flex items-start justify-between">
                        <div className="font-medium text-sm leading-5">
                          {b.title}
                          <span className="ml-2 text-[10px] text-gray-600 align-middle">⏰ 5m</span>
                        </div>
                        <div className="text-[10px] text-gray-600">{b.start}–{b.end}</div>
                      </div>
                      <div className="mt-1 flex items-center gap-1">
                        {b.priority && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-white/60 border border-black/10">
                            P: {b.priority}
                          </span>
                        )}
                        {b.effort && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-white/60 border border-black/10">
                            Effort: {effortText(b.effort)}
                          </span>
                        )}
                        {b.status && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-white/60 border border-black/10">
                            {b.status}
                          </span>
                        )}
                        {isCalendar && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-white/60 border border-indigo-300 text-indigo-700">
                            Calendar
                          </span>
                        )}
                        {b?.conflict && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-rose-100 border border-rose-300 text-rose-700">
                            Conflict
                          </span>
                        )}
                      </div>
                      <div className="mt-2 opacity-0 group-hover:opacity-100 transition flex items-center gap-2">
                        <button
                          className="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50"
                          onClick={(e) => { e.stopPropagation(); console.log('edit', b.id, blockClickAction); }}>
                          Edit
                        </button>
                        <button
                          className="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50"
                          onClick={(e) => { e.stopPropagation(); handleMarkDone(b); }}>
                          {isDone ? 'Undo' : 'Mark Done'}
                        </button>
                        <button
                          className="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50"
                          onClick={(e) => { e.stopPropagation(); console.log('move', b.id, blockDragAction); }}>
                          Move
                        </button>
                        <button
                          className="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50"
                          onClick={(e) => { e.stopPropagation(); console.log('resize', b.id, blockResizeAction); }}>
                          Resize
                        </button>
                        <button
                          className="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50"
                          onClick={(e) => { e.stopPropagation(); console.log('details', b.id, showDetailsAction); }}>
                          Details
                        </button>
                        {b?.conflict && (
                          <button
                            className="text-xs px-2 py-1 rounded border border-rose-300 bg-rose-50 hover:bg-rose-100 text-rose-700"
                            onClick={(e) => { e.stopPropagation(); console.log('resolve_conflict', b.id, resolveConflictAction); }}>
                            Resolve
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          <div className="px-4 py-3 border-t bg-gray-50 text-xs text-gray-600">
            Time step: {timeStepMinutes} min • Now indicator: {showNowIndicator ? 'On' : 'Off'}
          </div>
        </div>
      );
    };

    // 2) TodoTaskList
    const TodoTaskList = (props) => {
      const {
        dayIsoDate,
        tasks = [],
        onAction = {},
        showConflictWarnings = false,
        dailyGoal = {},
        timeZone = ''
      } = props;

      const [selected, setSelected] = useState(null);

      const handleAction = (type, payload) => {
        console.log('TodoTaskList action', type, payload, onAction);
      };

      return (
        <div className="w-full bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
          <div className="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
            <div>
              <div className="text-sm text-gray-500">Tasks for</div>
              <div className="font-semibold text-gray-900">{dayIsoDate || '—'} {timeZone ? `(${timeZone})` : ''}</div>
            </div>
            {dailyGoal?.target && (
              <div className="text-xs text-gray-600">Goal: {dailyGoal.target}</div>
            )}
          </div>
          <div className="divide-y">
            {Array.isArray(tasks) && tasks.length > 0 ? tasks.map((t) => (
              <div key={t.id || t.title} className="p-3 flex items-start gap-3 hover:bg-gray-50">
                <input type="checkbox" className="mt-1"
                  onChange={() => handleAction('toggle_complete', { id: t.id })} />
                <div className="flex-1">
                  <div className="font-medium text-gray-900">{t.title}</div>
                  <div className="text-xs text-gray-600">
                    {t.durationMins ? `${t.durationMins}m` : '—'} • P: {t.priority || '-'} • Effort: {t.effort || '-'}
                    {t.due && <span> • Due: {t.due}</span>}
                  </div>
                  {showConflictWarnings && t.conflict && (
                    <div className="mt-1 text-xs text-rose-700">⚠ {t.conflictHint || 'Conflict'}</div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                          onClick={() => handleAction('edit_task', { id: t.id })}>
                    Edit
                  </button>
                  <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                          onClick={() => handleAction('schedule_task', { id: t.id })}>
                    Schedule
                  </button>
                </div>
              </div>
            )) : (
              <div className="p-4 text-sm text-gray-600">No tasks.</div>
            )}
          </div>
        </div>
      );
    };

    // 3) CalendarEventsSidebar
    const CalendarEventsSidebar = (props) => {
      const {
        date,
        timezone,
        events = [],
        availableCalendars = [],
        visibleCalendarIds = [],
        timeFormat = '12h',
        workHours = {},
        showConflictWarnings = false,
        toggleCalendarVisibilityAction = {},
        openEventDetailsAction = {},
        changeDayAction = {},
        tooltipDelayMs = 300
      } = props;

      const [visible, setVisible] = useState(new Set(visibleCalendarIds));

      const formatTime = (hhmm) => {
        if (!hhmm) return '';
        if (timeFormat === '24h') return hhmm;
        const [hStr, mStr] = hhmm.split(':');
        let h = parseInt(hStr, 10);
        const m = mStr;
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        return `${h}:${m} ${ampm}`;
      };

      const toggleCal = (id) => {
        const next = new Set(visible);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        setVisible(next);
        console.log('toggleCalendar', id, toggleCalendarVisibilityAction);
      };

      return (
        <div className="w-full bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
          <div className="px-4 py-3 border-b bg-gray-50">
            <div className="text-sm text-gray-500">Calendar</div>
            <div className="font-semibold text-gray-900">{date || '—'} {timezone ? `(${timezone})` : ''}</div>
            {workHours?.start && workHours?.end && (
              <div className="text-xs text-gray-600">Work hours: {workHours.start}–{workHours.end}</div>
            )}
          </div>
          <div className="px-3 py-2 border-b">
            <div className="text-xs text-gray-600 mb-1">Calendars</div>
            <div className="flex flex-wrap gap-2">
              {Array.isArray(availableCalendars) && availableCalendars.length > 0 ? availableCalendars.map((c) => (
                <button key={c.id}
                        className={classNames(
                          'text-xs px-2 py-1 rounded border',
                          visible.has(c.id) ? 'bg-indigo-50 border-indigo-300 text-indigo-800' : 'bg-white hover:bg-gray-50'
                        )}
                        onClick={() => toggleCal(c.id)}>
                  {c.name || c.id}
                </button>
              )) : <span className="text-xs text-gray-500">No calendars</span>}
            </div>
          </div>
          <div className="divide-y">
            {Array.isArray(events) && events.length > 0 ? events
              .filter((e) => !e.calendarId || visible.has(e.calendarId))
              .map((e, idx) => (
                <div key={e.id || idx}
                     className="p-3 hover:bg-gray-50 cursor-pointer"
                     onClick={() => console.log('openEvent', e, openEventDetailsAction)}>
                  <div className="font-medium text-gray-900">{e.title || 'Event'}</div>
                  <div className="text-xs text-gray-600">{formatTime(e.start)}–{formatTime(e.end)} {e.location ? `• ${e.location}` : ''}</div>
                  {showConflictWarnings && e.conflict && (
                    <div className="text-xs text-rose-700 mt-1">⚠ {e.conflictHint || 'Conflict'}</div>
                  )}
                </div>
              )) : (
                <div className="p-4 text-sm text-gray-600">No events.</div>
              )}
          </div>
          <div className="px-4 py-3 border-t bg-gray-50 flex items-center justify-between">
            <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                    onClick={() => console.log('changeDay: prev', changeDayAction)}>
              Previous
            </button>
            <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                    onClick={() => console.log('changeDay: next', changeDayAction)}>
              Next
            </button>
          </div>
        </div>
      );
    };

    // 4) SchedulingConstraintsPanel
    const SchedulingConstraintsPanel = (props) => {
      const {
        id,
        title,
        iconUrl,
        timezone,
        constraints = {},
        onAction = {}
      } = props;

      const [local, setLocal] = useState(constraints);

      const updateC = (path, value) => {
        const next = JSON.parse(JSON.stringify(local || {}));
        const keys = path.split('.');
        let ref = next;
        for (let i = 0; i < keys.length - 1; i++) {
          const k = keys[i];
          ref[k] = ref[k] ?? {};
          ref = ref[k];
        }
        ref[keys[keys.length - 1]] = value;
        setLocal(next);
      };

      const apply = () => {
        console.log('apply_constraints', { id, constraints: local, onAction });
      };

      return (
        <div className="w-full bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
          <div className="px-4 py-3 border-b bg-gray-50 flex items-center gap-3">
            {iconUrl && <img src={iconUrl} alt="icon" className="w-5 h-5" />}
            <div className="font-semibold text-gray-900">{title || 'Constraints'}</div>
            {timezone && <div className="text-xs text-gray-500">({timezone})</div>}
          </div>
          <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div className="space-y-2">
              <div className="text-sm font-medium text-gray-800">Work hours</div>
              <div className="flex items-center gap-2">
                <input type="time" value={local?.workHours?.start || ''}
                       onChange={(e) => updateC('workHours.start', e.target.value)}
                       className="border rounded px-2 py-1 text-sm w-28" />
                <span className="text-gray-600 text-sm">to</span>
                <input type="time" value={local?.workHours?.end || ''}
                       onChange={(e) => updateC('workHours.end', e.target.value)}
                       className="border rounded px-2 py-1 text-sm w-28" />
              </div>
            </div>
            <div className="space-y-2">
              <div className="text-sm font-medium text-gray-800">Buffer minutes</div>
              <input type="number" min="0" value={local?.bufferMinutes ?? 0}
                     onChange={(e) => updateC('bufferMinutes', Number(e.target.value))}
                     className="border rounded px-2 py-1 text-sm w-28" />
            </div>
            <div className="space-y-2">
              <div className="text-sm font-medium text-gray-800">Max block length (mins)</div>
              <input type="number" min="15" step="5" value={local?.maxBlockLengthMins ?? 60}
                     onChange={(e) => updateC('maxBlockLengthMins', Number(e.target.value))}
                     className="border rounded px-2 py-1 text-sm w-36" />
            </div>
            <div className="space-y-2">
              <div className="text-sm font-medium text-gray-800">Break policy</div>
              <select value={local?.breakPolicy || 'None'}
                      onChange={(e) => updateC('breakPolicy', e.target.value)}
                      className="border rounded px-2 py-1 text-sm w-40">
                <option>None</option>
                <option>Short</option>
                <option>Pomodoro</option>
              </select>
            </div>
            <div className="space-y-2 md:col-span-2">
              <div className="text-sm font-medium text-gray-800">Focus windows</div>
              <div className="text-xs text-gray-600 mb-1">Adjust manually in grid if needed.</div>
              <div className="flex flex-wrap gap-2">
                {Array.isArray(local?.focusWindows) && local.focusWindows.length > 0 ? local.focusWindows.map((fw, idx) => (
                  <div key={idx} className="flex items-center gap-1 text-xs border rounded px-2 py-1">
                    <span>{fw.start}–{fw.end}</span>
                  </div>
                )) : <span className="text-xs text-gray-500">None</span>}
              </div>
            </div>
            <div className="space-y-2">
              <label className="inline-flex items-center gap-2 text-sm text-gray-800">
                <input type="checkbox" checked={!!local?.autoReschedule}
                       onChange={(e) => updateC('autoReschedule', e.target.checked)} />
                Auto-reschedule on conflicts
              </label>
            </div>
          </div>
          <div className="px-4 py-3 border-t bg-gray-50 flex items-center justify-end gap-2">
            <button className="text-sm px-3 py-1.5 border rounded hover:bg-gray-50"
                    onClick={() => setLocal(constraints)}>Reset</button>
            <button className="text-sm px-3 py-1.5 border rounded bg-indigo-600 text-white hover:bg-indigo-700"
                    onClick={apply}>Apply</button>
          </div>
        </div>
      );
    };

    // 5) ConflictWarningBanner
    const ConflictWarningBanner = (props) => {
      const {
        id,
        title,
        iconUrl,
        conflicts = [],
        applySuggestionAction = {},
        resolveAllAction = {},
        openBlockEditorAction = {},
        maxVisibleConflicts = 3,
        showSeverityLegend = false
      } = props;

      const visibleConflicts = Array.isArray(conflicts) ? conflicts.slice(0, maxVisibleConflicts) : [];

      const sevBadge = (sev) => {
        if (!sev) return 'bg-gray-100 text-gray-700 border-gray-200';
        const s = ('' + sev).toLowerCase();
        if (s === 'high' || s === 'error') return 'bg-red-100 text-red-800 border-red-200';
        if (s === 'warn' || s === 'warning') return 'bg-amber-100 text-amber-800 border-amber-200';
        return 'bg-sky-100 text-sky-800 border-sky-200';
        };

      return (
        <div className="w-full rounded-lg border shadow bg-white overflow-hidden">
          <div className="px-4 py-3 border-b bg-amber-50 flex items-center gap-2">
            <span>⚠️</span>
            <div className="font-semibold text-gray-900">{title || 'Scheduling conflicts'}</div>
          </div>
          <div>
            {visibleConflicts.length === 0 ? (
              <div className="p-4 text-sm text-gray-700">No conflicts.</div>
            ) : visibleConflicts.map((c, idx) => (
              <div key={c.blockId || idx} className="p-3 border-b last:border-b-0 flex items-start gap-3">
                <div className={classNames('text-xs px-2 py-0.5 rounded border', sevBadge(c.severity))}>
                  {c.severity || 'Info'}
                </div>
                <div className="flex-1">
                  <div className="text-sm font-medium text-gray-900">{c.blockTitle || c.blockId}</div>
                  <div className="text-xs text-gray-700">
                    Issue: {c.issue || '-'} • Suggestion: {c.suggestion || '-'}
                  </div>
                  {c.hint && <div className="text-xs text-gray-600 mt-1">{c.hint}</div>}
                </div>
                <div className="flex items-center gap-2">
                  <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                          onClick={() => console.log('applySuggestion', c.blockId, applySuggestionAction)}>
                    Apply
                  </button>
                  <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                          onClick={() => console.log('openEditor', c.blockId, openBlockEditorAction)}>
                    Edit
                  </button>
                </div>
              </div>
            ))}
          </div>
          <div className="px-4 py-3 border-t bg-gray-50 flex items-center justify-between">
            {showSeverityLegend && (
              <div className="text-xs text-gray-700 flex items-center gap-2">
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-sm bg-red-200 inline-block" />High</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-sm bg-amber-200 inline-block" />Warn</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-sm bg-sky-200 inline-block" />Info</span>
              </div>
            )}
            <button className="text-xs px-2 py-1 border rounded hover:bg-gray-50"
                    onClick={() => console.log('resolve_all', resolveAllAction)}>
              Resolve all
            </button>
          </div>
        </div>
      );
    };

    // Component Registry
    const ComponentRegistry = {
      TimeBlockGrid: TimeBlockGrid,
      TodoTaskList: TodoTaskList,
      CalendarEventsSidebar: CalendarEventsSidebar,
      SchedulingConstraintsPanel: SchedulingConstraintsPanel,
      ConflictWarningBanner: ConflictWarningBanner
    };

    // Renderer that tolerates *Props names by stripping suffix
    const ComponentRenderer = ({ componentName, props }) => {
      let Component = ComponentRegistry[componentName];
      if (!Component && componentName && componentName.endsWith('Props')) {
        const alt = componentName.replace(/Props$/, '');
        Component = ComponentRegistry[alt];
      }
      if (!Component) {
        return (
          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">Component "{componentName}" not found</p>
            <pre className="text-xs text-yellow-700 mt-2 overflow-auto">{JSON.stringify(props, null, 2)}</pre>
          </div>
        );
      }
      return <Component {...props} />;
    };

    // Message rendering
    const ContentChunkRenderer = ({ chunk }) => {
      if (!chunk) return null;
      if (chunk.type === 'text') {
        const text = chunk.text || '';
        const lines = text.split('\n');
        return (
          <div className="prose prose-sm max-w-none">
            {lines.map((line, idx) => (
              <p key={idx} className="my-2 whitespace-pre-wrap">{line}</p>
            ))}
          </div>
        );
      }
      if (chunk.type === 'component' && chunk.component) {
        const { name, props } = chunk.component;
        return (
          <div className="my-3">
            <ComponentRenderer componentName={name} props={props || {}} />
          </div>
        );
      }
      // Fallback if assistant directly provided a component object
      if (chunk.name) {
        return (
          <div className="my-3">
            <ComponentRenderer componentName={chunk.name} props={chunk.props || {}} />
          </div>
        );
      }
      return null;
    };

    const MessageBubble = ({ role, content }) => {
      const isUser = role === 'user';
      const wrapperCls = isUser ? 'items-end' : 'items-start';
      const bubbleBg = isUser ? 'bg-indigo-600 text-white' : 'bg-white text-gray-900 border border-gray-200';
      const bubble = (children) => (
        <div className={classNames('max-w-3xl w-full rounded-2xl px-4 py-3 shadow-sm', bubbleBg)}>
          {children}
        </div>
      );

      return (
        <div className={classNames('w-full flex my-3', wrapperCls)}>
          <div className={classNames('w-full flex', isUser ? 'justify-end' : 'justify-start')}>
            {Array.isArray(content) ? bubble(
              <div className="space-y-3">
                {content.map((chunk, idx) => (
                  <ContentChunkRenderer key={idx} chunk={chunk} />
                ))}
              </div>
            ) : bubble(<div className="whitespace-pre-wrap">{content}</div>)}
          </div>
        </div>
      );
    };

    const ConversationView = ({ conversation = [] }) => {
      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-xl">🗓️</span>
                <div>
                  <div className="font-semibold text-gray-900">Conversation Viewer</div>
                  <div className="text-xs text-gray-600">UI component conversation: time-blocked schedule</div>
                </div>
              </div>
              <a className="text-xs text-indigo-700 hover:underline" href="#" onClick={(e)=>e.preventDefault()}>Help</a>
            </div>
          </header>
          <main className="max-w-6xl mx-auto px-4 py-6">
            {Array.isArray(conversation) && conversation.length > 0 ? conversation.map((msg, idx) => (
              <MessageBubble key={idx} role={msg.role} content={msg.content} />
            )) : (
              <div className="text-center text-gray-600">No conversation.</div>
            )}
          </main>
        </div>
      );
    };

    const rootEl = document.getElementById("root");
    if (rootEl) {
      const root = createRoot(rootEl);
      root.render(<ConversationView conversation={conversationData} />);
    }
  </script>
</body>
</html>